import os
import subprocess
import time

GITHUB_REPO = "https://github.com/alwansan/C-App.git"
PACKAGE = "com.alwansan.c_app"
PKG_PATH = PACKAGE.replace(".", "/")
VERSION = int(time.time())


def run(cmd):
    print(f"üîÑ {cmd}")
    return subprocess.run(cmd, shell=True).returncode == 0


def write(path, content):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, "w", encoding="utf-8") as f:
        f.write(content.strip() + "\n")
    print(f"üìÑ {path}")


print("üõ†Ô∏è Building project...")

# ---------------- Gradle ----------------

write("settings.gradle.kts", """
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositories {
        google()
        mavenCentral()
    }
}
rootProject.name = "C-App"
include(":app")
""")

write("build.gradle.kts", """
plugins {
    id("com.android.application") version "8.2.2" apply false
    id("org.jetbrains.kotlin.android") version "1.9.22" apply false
}
""")

write("gradle.properties", """
android.useAndroidX=true
android.enableJetifier=true
""")

write("app/build.gradle.kts", f"""
plugins {{
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
}}

android {{
    namespace = "{PACKAGE}"
    compileSdk = 34

    defaultConfig {{
        applicationId = "{PACKAGE}"
        minSdk = 26
        targetSdk = 34
        versionCode = {VERSION}
        versionName = "1.0.{VERSION}"
    }}

    buildTypes {{
        release {{
            isMinifyEnabled = false
        }}
    }}

    compileOptions {{
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
    }}
    kotlinOptions {{
        jvmTarget = "17"
    }}
}}

dependencies {{
    implementation("androidx.core:core-ktx:1.12.0")
    implementation("androidx.appcompat:appcompat:1.6.1")
    implementation("com.google.android.material:material:1.11.0")
}}
""")

# ---------------- Kotlin ----------------

write(f"app/src/main/java/{PKG_PATH}/MainActivity.kt", f"""
package {PACKAGE}

import android.os.Bundle
import androidx.appcompat.app.AppCompatActivity

class MainActivity : AppCompatActivity() {{

    override fun onCreate(savedInstanceState: Bundle?) {{
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
    }}
}}
""")

# ---------------- Layout ----------------

write("app/src/main/res/layout/activity_main.xml", """
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:gravity="center"
    android:orientation="vertical">

    <TextView
        android:text="C App Running"
        android:textSize="20sp"
        android:textColor="#FFFFFF"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"/>

</LinearLayout>
""")

# ---------------- Manifest ----------------

write("app/src/main/AndroidManifest.xml", f"""
<manifest xmlns:android="http://schemas.android.com/apk/res/android">

    <application
        android:label="C"
        android:theme="@style/Theme.AppCompat.DayNight.NoActionBar">

        <activity
            android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>

    </application>
</manifest>
""")

# ---------------- Workflow ----------------

write(".github/workflows/android.yml", """
name: Android CI

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.5

    - run: gradle assembleDebug

    - uses: actions/upload-artifact@v4
      with:
        name: C-App-Debug
        path: app/build/outputs/apk/debug/app-debug.apk
""")

# ---------------- Git ----------------

print("üîÑ Git push...")

run("git config --global --add safe.directory '*'")

if not os.path.exists(".git"):
    run("git init")

run("git add .")
run(f'git commit -m "Auto Build {VERSION}" || true')
run("git branch -M main")
run(f"git remote remove origin || true")
run(f"git remote add origin {GITHUB_REPO}")
run("git push -u origin main --force")

print("üéâ DONE ‚Äì APK will build successfully")